name: Sui Protocol Version Monitor

concurrency:
  group: sui-protocol-version-monitor

on:
  workflow_call:
    inputs:
      environment:
        type: string
        required: true
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        default: 'devnet'
        options:
        - devnet
        - testnet
        - mainnet

jobs:
  test:
    name: Sui Protocol Version Monitor
    runs-on: [self-hosted, self-hosted-arc]

    steps:
    - name: Checkout sui source
      uses: actions/checkout@7dd9e2a3dc350cf687eb1b2a4fadfee8c8e49675 # pin@v3

    - name: Download an artifact for the last saved ${{ inputs.environment }} protocol version
      id: download-artifact
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{secrets.GITHUB_TOKEN}}
        workflow: sui-protocol-version-monitor.yml
        workflow_conclusion: success
        name: ${{ inputs.environment }}-protocol-version
        check_artifacts: true
        path: /tmp/${{ inputs.environment }}_saved_protocol_version.txt
        if_no_artifact_found: warn

    - name: Read last saved protocol version for ${{ inputs.environment }}
      continue-on-error: true
      shell: bash
      run: |
        echo "saved_protocol_version=`cat /tmp/${{ inputs.environment }}_saved_protocol_version.txt/${{ inputs.environment }}_saved_protocol_version.txt || ''`" >> $GITHUB_ENV

    - name: Read live protocol version in ${{ inputs.environment }}
      shell: bash
      run: | 
        curl -s https://fullnode.${{ inputs.environment }}.sui.io:443 -H 'Content-Type: application/json' -d '{"jsonrpc":"2.0", "method":"suix_getLatestSuiSystemState", "params":[], "id":1}' | jq -r '.result.protocolVersion' > /tmp/${{ inputs.environment }}_protocol.txt
        echo "current_protocol_version=`cat /tmp/${{ inputs.environment }}_protocol.txt`" >> $GITHUB_ENV

    - name: Update framework/${{ inputs.environment }}
      if: ${{ env.saved_protocol_version != '' && env.current_protocol_version > env.saved_protocol_version }}
      continue-on-error: true
      uses: LucasRuy/sync-branch-action@v1.1.1
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SOURCE_BRANCH: ${{ inputs.environment }}
        DESTINATION_BRANCH: framework/${{ inputs.environment }}

    - name: Save current protocol version for ${{ inputs.environment }} to artifact
      shell: bash
      run: |
        echo ${{ env.current_protocol_version }} > /tmp/${{ inputs.environment }}_protocol.txt
        mv /tmp/${{ inputs.environment }}_protocol.txt /tmp/${{ inputs.environment }}_saved_protocol_version.txt

    - name: Upload an artifact for current ${{ inputs.environment }} protocol version
      uses: actions/upload-artifact@v3
      with:
        name: ${{ inputs.environment }}-protocol-version
        path: /tmp/${{ inputs.environment }}_saved_protocol_version.txt
