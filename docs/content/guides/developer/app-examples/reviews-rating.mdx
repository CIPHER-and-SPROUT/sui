---
title: Reviews Rating
---

The following documentation goes through an example implementation of a review rating platform for the food service industry on Sui.
Unlike traditional review rating platforms, that often do not disclose the algorithm used to rate reviews, the on-chain platform uses an algorithm that is published on-chain for everyone to see and verify.
Furthermore, all submitted reviews are scored and ordered on-chain which is feasible due to the low gas cost of computation on Sui.

## Personas

There are four actors in the typical workflow of the reviews rating example.  

```mermaid
sequenceDiagram
  Service ->> Dashboard: Add service to dashboard.
  Service ->> User: Send proof of experience.
  User ->> Service: Send review
  Service ->> User: Send reward
  Service ->> Moderator: Add as a service moderator
  Moderator ->> Service: Remove abused review
```

### Service owners

Service owners are entities like restaurants that list their services on the platform. Service owners allocate a specific amount of SUI as a reward pool. Assets from the pool are used to provide rewards for high-rated reviews. A Proof of Experience (PoE) NFT confirms the reviewer used the service, which they burn to provide a verified review. Service owners can provide their customers with unique identifiers, perhaps using QR codes, to identify individual reviewers.

### Reviewers

Reviewers are consumers of services that use the review system. Reviewers provide feedback in the form of comments that detail specific aspects of the service as well as a star rating to inform others. The reviews are rated, with the most effective reviews getting the highest rating. Service owners award the 10 highest rated reviews for their service. How often the rewards are distributed is up to the service owner's discretion; for example, it can be distributed once a day or once a month.

### Review readers

Review readers access reviews to make informed decisions on selecting services. Readers rate reviews by casting up or down votes. The review readers' ratings are factored into the algorithm that rates the reviews, with the authors of the highest-rated reviews getting awarded. Although it is not implemented as part of this guide, a proportion of the review reward may be awarded to review readers who has participated in rating reviews by casting their votes.

### Moderators

Moderators monitor content of the reviews and can delete any reviews that contain inappropriate content.

The incentive mechanism is not implemented for this guide, but service owners can all pay into a pool that goes to moderators, on a rolling basis. People can stake moderators to influence what proportion of the reward each moderator gets, up to a limit (imagine how validators are staked on-chain), and moderator decisions are decided by quorum of stake weight. This is a way to ensure that moderators have incentives to do their job well.

## How reviews are rated

The reviews are rated (scored) on-chain using following criteria
- Intrinsic score (IS)
  - Length of content
- Extrinsic score (ES)
  - Number of votes received
- Verification multiplier (VM)
  - Reviews with PoE get a multiplier to improve rating

```
Total Score = (IS + ES) * VM
```

## Smart contracts

There are several modules that create the backend logic for the example.

### dashboard.move

The `dashboard.move` module defines the `Dashboard` struct that is used to group services.

```move
struct Dashboard has key, store {
  id: UID,
  service_type: String
}
```

The services are grouped by attributes, which can be cuisine type, geographical location, operating hours, google maps ID, and so on. To keep it basic, the example stores only `service_type` (for example, fast food, Chinese, Italian).

### service.move

This module defines the `Service` struct, which service owners manage.

```move
struct Service has key, store {
  id: UID,
  reward_pool: Balance<SUI>,
  reward: u64,
  top_reviews: MultiMap<ID>,
  reviews: Table<ID, ID>,
  moderators: Table<address, address>,
  overall_rate: u64,
  name: String
}
```

All the submitted reviews are stored in `reviews` field, and the top rated reviews are stored in `top_reviews` field, which has `MultiMap<ID>` type. The [multimap module](#multimap) defines the type.

The same amount is rewarded to top reviewers, and the reward is distributed to 10 participants at most.
The pool of `SUI` tokens that will be distributed to reviewers is stored in `reward_pool` field, and the amount of `SUI` tokens that will be awarded to each participant is configured in `reward` field.

```move
struct AdminCap has key, store {
  id: UID,
  service_id: ID
}
struct Moderator has key {
  id: UID,
  service_id: ID,
}
```
This guide follows a [capabilities pattern](../../../concepts/sui-move-concepts/patterns/capabilities.mdx) to manage authorizations.
For example, `SERVICE OWNERS` are given `AdminCap` and `MODERATORS` are given `Moderator` such that only they are allowed to perform privileged operations.

### multimap.move {#multimap}

`MultiMap` is an implementation of the `multimap` data structure (https://en.wikipedia.org/wiki/Multimap), which keeps all the reviews sorted. Using `MultiMap`, all the reviews are ordered by rating, with the highest rated reviews coming first.

```move
struct MultiMap<K: copy> has copy, drop, store {
  contents: vector<Entry<K>>,
}
struct Entry<K: copy> has copy, drop, store {
  key: K,
  priority: u64,
}
```
The `object_id` of a `review` object is used as a `key` and `total_score` is used as `priority` for a new entry.

Note that `vector` is used to store the contents of the `MultiMap`. This is acceptable in our use case because the rewards are distributed to 10 participants at most.

```move
public fun insert<K: copy>(self: &mut MultiMap<K>, key: K, priority: u64) {
  assert!(!contains(self, &key), EKeyAlreadyExists);
  let len = vector::length(&self.contents);
  let (lo, hi) = (0, len);
  while (lo < hi) {
    let mid = (hi - lo) / 2 + lo;
    let ele = vector::borrow(&self.contents, mid);
    if (priority > ele.priority) {
      hi = mid;
    } else {
      lo = mid + 1;
    }
  };
  vector::insert(&mut self.contents, Entry { key, priority }, lo);
}
```
`Binary Search` is implemented to insert a new entry in the `MultiMap`. The `insert` function is used to insert a new entry in the `MultiMap`.

### review.move

This module defines the `Review` struct.

```move
struct Review has key, store {
  id: UID,
  owner: address,
  service_id: ID,
  content: String,
  // intrinsic score
  len: u64,
  // extrinsic score
  votes: u64,
  time_issued: u64,
  // proof of experience
  has_poe: bool,
  total_score: u64,
  overall_rate: u8,
}
```

In addition to the content of a review, all the elements that are required to compute total score are stored in a `Review` object.

## Deployment

Navigate to the [setup folder](https://github.com/MystenLabs/reviews-ratings-poc/tree/main/setup) of the repository and execute the `publish.sh` script. Refer to the [README instructions](https://github.com/MystenLabs/reviews-ratings-poc/blob/main/README.md) for deploying the smart contracts.

## Frontend
The frontend module is written in React, and is structured to provide a responsive user experience for interacting with a review rating platform.
On the [`page` component](https://github.com/MystenLabs/reviews-ratings-poc/blob/main/app/src/app/page.tsx), a user can be logged in as a `SERVICE OWNER` or a `USER`.

### Directories structure

The frontend is a NextJS project, that follows the NextJS App Router [project structure](https://nextjs.org/docs/app/building-your-application/routing).
The main code of the frontend lies under the [app/src/](https://github.com/MystenLabs/reviews-ratings-poc/blob/main/app/src/app/) directory.
The main sub-directories are:
  - [app/](https://github.com/MystenLabs/reviews-ratings-poc/blob/main/app/src/app/): The main code of the pages and the global styles.
  - [components/](https://github.com/MystenLabs/reviews-ratings-poc/blob/main/app/src/components): The reusable components of the app, organized in sub-directories.
  - [hooks/](https://github.com/MystenLabs/reviews-ratings-poc/blob/main/app/src/hooks): The custom hooks used in the app.
  - [serviceOwner/](https://github.com/MystenLabs/reviews-ratings-poc/blob/main/app/src/serviceOwner): The pages for `SERVICE OWNER`.
  - [types/](https://github.com/MystenLabs/reviews-ratings-poc/blob/main/app/src/types): The types/interfaces used in the app.
  - [user/](https://github.com/MystenLabs/reviews-ratings-poc/blob/main/app/src/user): The pages for `USER`.

### Components and custom hooks for state management

- **Custom Hooks:** To keep the code as structured as possible, multiple custom hooks are utilized to manage the list of reviews associated with a service. The [useGetReviews](https://github.com/MystenLabs/reviews-ratings-poc/blob/main/app/src/hooks/useGetReviews.ts)
custom hook encapsulates the service, exposing all the required information (with fields such as `nameOfService`, `listOfReviews`, `listOfStars`) to display the reviews in a table.
Multiple additional custom hooks, such as [useDashboardCreation](https://github.com/MystenLabs/reviews-ratings-poc/blob/main/app/src/hooks/useDashboardCreation.ts), and [useServiceReview](https://github.com/MystenLabs/reviews-ratings-poc/blob/main/app/src/hooks/useServiceReview.ts) are encapsulating their own piece of state and logic to make the code readable and maintainable.

- **Component for Adding a New Review:** The [AddReview](https://github.com/MystenLabs/reviews-ratings-poc/blob/main/app/src/components/review/AddReview.tsx) component is implemented to facilitate the creation of a new review. It is rendered by the [servicePage](https://github.com/MystenLabs/reviews-ratings-poc/blob/main/app/src/app/service/[id]/page.tsx) to collect a review entry from a `USER` and uses the `signAndExecuteTransactionBlock` function of the [useWalletKit] hook to execute the transaction.

- **Proof of Experience Generation:** Proof of Experience(PoE) is an NFT that is minted by `SERVICE OWNER` for customers after they dine at the restaurant; customers can, then, burn the PoE to write a high-rated review later. Minting an NFT is facilitated by the [ownedServicePage](https://github.com/MystenLabs/reviews-ratings-poc/blob/main/app/src/app/serviceOwner/ownedServices/page.tsx) component. This component is using the [useServicePoEGeneration](https://github.com/MystenLabs/reviews-ratings-poc/blob/main/app/src/hooks/useServicePoeGeneration.ts) custom hook.

- **Delete a Review:** The moderator can delete a review that contain inappropriate content. [moderatorRemovePage](https://github.com/MystenLabs/reviews-ratings-poc/blob/main/app/src/app/user/moderator/remove/page.tsx) component is used to delete a review.

:::info

The complete app example can be found in [the reviews-rating repo](https://github.com/MystenLabs/reviews-ratings-poc).

:::
